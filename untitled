

切换前的要求
	1.新的服务全部部署后并映射到临时的预发布域名,并且至少在预发布环境中稳定运行3天后才能正式切换

上线切换计划
	1.数据库正式环境rds:rdsvl32r4cesrb288x1a，由于都是新增表并且是老表里往新表里导入数据所以数据库这块没什么特别操作,回退只需删掉新增的ai_开头的表就行

  2.应用服务器这块,所有新的应用都部署在新的服务器上,老的应用保留在原有服务器上,切换的话只需要停掉老的服务启用新的服务，回退只需要反向操作

  	老的服务:
  		1)官网应用121.40.166.225,121.41.100.59,需要停掉
  		2)微商城应用120.26.245.55,120.26.246.94,120.26.71.23,需要停掉
        3)管理端应用121.40.207.62,需要停掉
        4)打单发货应用121.40.203.122,需要停掉
        5)o2o应用120.26.74.197,需要重新部署(可以提前做,改动是向上兼容的,只是添加了对新回调接口的访问权限)
        6)rpc-mall应用121.40.166.225,120.26.230.105,需要停掉
        7)platform应用121.40.166.225,121.41.100.59,需要停掉
        8)aishang-bsi应用121.40.203.122,需要停掉
        9)采购端应用121.40.203.122,需要停掉

    新的服务:
    	1)aishang-mall-cron:定时器服务,部署在一台新的服务器上,建议配置单台中等偏下
    	2)aishang-mall-notify:回调服务,部署在n台新的服务器上,建议配置n台中等,n>1
    	3)aishang-mall-mobile:微商城用户端,部署在n台新的服务器上,建议配置n台中等,n>1
    	4)aishang-mall-rest:微商城服务,部署在n台新的服务器上,建议配置n台中等,n>1

    	5)aishang-mall-management-operation:微商城管理端,部署在一台新的服务器上,建议配置单台中等
    	6)aishang-mall-management-rest:微商城管理端服务,部署在一台新的服务器上,建议配置单台中等
    	7)aishang-mall-management-purchase-web:采购系统用户端,部署在一台新的服务器上,建议配置单台中等
	    8)aishang-mall-management-purchase-rest:采购系统服务,部署在一台新的服务器上,建议配置单台中等

	    9)官网没想好怎么替换

	    10)监控模块,需要部署admin-server和eureka-server并且被监控的服务必须是基于springboot的,目前只能监控到cron和notify其他要监控的需要改对应模块的代码(这个看情况是不是要做)

	 不需要动的服务
	 	1)component-mq消费节点1:121.41.93.166
	 	2)component-message消费节点1:121.41.100.59

	 其他要注意的
	 	1)提前写快速关闭服务和启动服务的脚本在各个服务器上方便到时候切换,怕到时候大半夜敲命令敲错

 	3.nginx的切换
 		nginx-120.26.230.105
 			upstream backend{   
         server 10.117.80.211:8080;#7 微商城老应用负载1
         server 10.117.74.149:8080;#8 微商城老应用负载2 
         server 10.117.221.139:8080;#9 微商城老应用负载3
  		}
  		1)直接注释789 添加新的aishang-mall-mobile应用的ip
  		2)添加upstream aishang-mall-rest 添加新的应用aishang-mall-rest的ip
      3)添加upstream aishang-mall-notify 添加新的应用aishang-mall-rest的ip

 		nginx-120.26.131.123
 			 upstream backend{ 
	         server 10.168.42.68:8080;#20 官网老应用负载1
	         server 10.117.179.10:8080;#21 官网老应用负载2
  		 }
      1)直接注释20 21
        upstream api-mall{
          server 10.117.179.10:9080;
          server 10.168.42.68:9080;
        }
      2)直接注释
        upstream purchase{
              server 10.168.81.79:8781;#采购端web应用
        }
      3)注释并追加新aishang-mall-management-purchase-web应用的ip
      4)添加upstream aishang-mall-management-operation应用的ip

  4.keycloak
      1)添加aishang-mall-management-operation配置
      2)添加aishang-mall-management-rest配置
      3)添加aishang-mall-management-purchase-web配置
      4)添加aishang-mall-management-purchase-rest配置

 	5.微信公众号配置
      1)支付授权目录需要修改
        修改前
          http://m.iishang.com/myOrder/
          http://m.iishang.com/order/
        修改后  aishang-mall-mobile-host 应该还是m.iishang.com
          http://aishang-mall-mobile-host/orders/
          http://aishang-mall-mobile-host/user/order/
  
